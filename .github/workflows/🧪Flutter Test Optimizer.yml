name: ğŸ§ªFlutter Test Optimizer

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to optimize tests (leave empty for current)'
        required: false
        default: ''
        type: string
      auto_fix_tests:
        description: 'Auto-fix test issues and commit changes'
        required: false
        default: true
        type: boolean
      run_performance_analysis:
        description: 'Analyze test performance and report slow tests'
        required: false
        default: true
        type: boolean

jobs:
  test-optimizer:
    name: ğŸ§ª Test Optimization & Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Show test optimization info
        run: |
          echo "ğŸ§ª Flutter Test Optimizer"
          echo "ğŸ“¦ Target Branch: ${{ github.event.inputs.target_branch || github.ref_name }}"
          echo "ğŸ”§ Auto-fix enabled: ${{ github.event.inputs.auto_fix_tests || 'true' }}"
          echo "ğŸ“Š Performance analysis: ${{ github.event.inputs.run_performance_analysis || 'true' }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ“… Timestamp: $(date)"

      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.target_branch || github.ref_name }}

      - name: ğŸ“‹ Verify test branch checkout
        run: |
          echo "âœ… Current branch: $(git branch --show-current)"
          echo "ğŸ“ Latest commit: $(git log -1 --oneline)"
          echo "ğŸ‘¤ Commit author: $(git log -1 --pretty=format:'%an <%ae>')"
          echo "ğŸ“… Commit date: $(git log -1 --pretty=format:'%ad')"
          echo ""
          echo "ğŸ§ª Test directory analysis:"
          if [ -d "test/" ]; then
            echo "ğŸ“ Test files found: $(find test/ -name "*.dart" | wc -l)"
            echo "ğŸ“‹ Test structure:"
            find test/ -name "*.dart" | head -10
          else
            echo "âŒ No test directory found!"
            exit 1
          fi

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: ğŸ“Š Flutter doctor for tests
        run: flutter doctor -v

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ§¹ Pre-optimization analysis
        run: |
          echo "## ğŸ” Pre-Optimization Test Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Contar archivos de test
          TEST_FILES=$(find test/ -name "*.dart" | wc -l)
          echo "ğŸ“ **Total test files**: $TEST_FILES" >> $GITHUB_STEP_SUMMARY
          
          # Analizar imports en tests
          echo "ğŸ” **Analyzing test imports...**" >> $GITHUB_STEP_SUMMARY
          UNUSED_IMPORTS=$(find test/ -name "*.dart" -exec grep -l "^import" {} \; | wc -l)
          echo "ğŸ“‹ Files with imports: $UNUSED_IMPORTS" >> $GITHUB_STEP_SUMMARY
          
          # Detectar patterns comunes
          echo "ğŸ¯ **Common test patterns detected**:" >> $GITHUB_STEP_SUMMARY
          TESTWIDGET_COUNT=$(find test/ -name "*.dart" -exec grep -l "testWidgets" {} \; | wc -l)
          UNITTEST_COUNT=$(find test/ -name "*.dart" -exec grep -l "test(" {} \; | wc -l)
          GROUP_COUNT=$(find test/ -name "*.dart" -exec grep -l "group(" {} \; | wc -l)
          
          echo "- Widget tests: $TESTWIDGET_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests: $UNITTEST_COUNT" >> $GITHUB_STEP_SUMMARY  
          echo "- Test groups: $GROUP_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ¨ Auto-format test files
        run: |
          echo "ğŸ¨ Formatting test files..."
          if ! dart format --set-exit-if-changed test/ 2>/dev/null; then
            echo "ğŸ“ Test formatting issues detected!"
            if [ "${{ github.event.inputs.auto_fix_tests }}" = "true" ]; then
              echo "ğŸ”§ Auto-fixing test formatting..."
              dart format test/
              echo "âœ… Test files formatted!"
            else
              echo "âš ï¸ Auto-fix disabled. Test files need manual formatting."
            fi
          else
            echo "âœ… All test files are properly formatted!"
          fi

      - name: ğŸ§¹ Optimize test imports and apply fixes
        run: |
          echo "ğŸ§¹ Optimizing test files with dart fix..."
          
          # Aplicar fixes especÃ­ficamente en la carpeta test
          dart fix --apply test/
          
          echo "ğŸ“‹ Checking what was fixed in tests..."
          if ! git diff --quiet test/; then
            echo "âœ… Test optimizations applied!"
            echo "ğŸ“ Files modified in test directory:"
            git diff --name-only test/
            
            echo "ğŸ” Changes preview:"
            git diff --stat test/
          else
            echo "â„¹ï¸ No automatic fixes needed in test files."
          fi

      - name: ğŸ” Test analysis and linting
        run: |
          echo "ğŸ” Running analysis specifically on test files..."
          flutter analyze test/ --fatal-infos || echo "âš ï¸ Analysis found issues in tests"

      - name: ğŸ§ª Run tests with detailed output
        if: github.event.inputs.run_performance_analysis == 'true'
        run: |
          echo "ğŸ§ª Running tests with performance analysis..."
          
          # Ejecutar tests con tiempo detallado
          START_TIME=$(date +%s)
          flutter test --reporter=expanded --coverage 2>&1 | tee test_output.log
          END_TIME=$(date +%s)
          TOTAL_TIME=$((END_TIME - START_TIME))
          
          echo "â±ï¸ Total test execution time: ${TOTAL_TIME}s"
          echo "TEST_EXECUTION_TIME=${TOTAL_TIME}" >> $GITHUB_ENV

      - name: ğŸ“Š Test performance analysis
        if: github.event.inputs.run_performance_analysis == 'true'
        run: |
          echo "ğŸ“Š Analyzing test performance..."
          
          echo "## ğŸ“Š Test Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ **Total execution time**: ${TEST_EXECUTION_TIME:-N/A}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Analizar output de tests para identificar lentos
          if [ -f "test_output.log" ]; then
            echo "ğŸŒ **Potentially slow tests**:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            # Buscar patrones que indiquen tests lentos (mÃ¡s de 1000ms tÃ­picamente)
            grep -E "(took [0-9]{4,}ms|SKIP|FAIL)" test_output.log | head -10 >> $GITHUB_STEP_SUMMARY || echo "No slow tests detected" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Coverage info si estÃ¡ disponible
          if [ -f "coverage/lcov.info" ]; then
            echo "ğŸ“ˆ **Coverage generated successfully**" >> $GITHUB_STEP_SUMMARY
            COVERAGE_LINES=$(wc -l < coverage/lcov.info)
            echo "ğŸ“‹ Coverage file size: $COVERAGE_LINES lines" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ”§ Commit test optimizations
        if: github.event.inputs.auto_fix_tests == 'true'
        run: |
          echo "ğŸ”§ Committing test optimizations..."
          
          if ! git diff --quiet; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action [bot]"
            
            echo "ğŸ“‹ Files that will be committed:"
            git diff --name-only
            
            git add .
            git commit -m "ğŸ§ª Auto-optimize test files: formatting, imports, and fixes [skip ci]"
            
            # Determinar la rama correcta para el push
            TARGET_BRANCH="${{ github.event.inputs.target_branch || github.ref_name }}"
            
            if git push origin "$TARGET_BRANCH" 2>/dev/null; then
              echo "âœ… Test optimizations committed and pushed!"
              echo "ğŸ”„ Contributors should pull the latest changes."
              
              echo "## ğŸ§ª Test Optimization Summary" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Automatic optimizations applied and committed**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“ **Files optimized**:" >> $GITHUB_STEP_SUMMARY
              git diff --name-only HEAD~1 | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ”„ **Action Required**: Pull the latest changes to your local branch:" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo "git pull origin $TARGET_BRANCH" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Could not push test optimizations. This may be normal for some branch types."
              echo "ğŸ“ Test optimizations applied locally for this analysis."
            fi
          else
            echo "â„¹ï¸ No changes to commit - tests were already optimized."
          fi

      - name: ğŸ“‹ Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-analysis-${{ github.event.inputs.target_branch || github.ref_name }}-${{ github.run_number }}
          path: |
            test_output.log
            coverage/
          retention-days: 7
        continue-on-error: true

      - name: ğŸ“ Final test optimization report
        run: |
          echo "## ğŸ‰ Test Optimization Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ What was analyzed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Test file formatting" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Import optimization" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Automatic dart fixes" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code analysis" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.run_performance_analysis }}" = "true" ]; then
            echo "- âœ… Performance analysis" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Test execution timing" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ Settings used:" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.event.inputs.target_branch || github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-fix**: ${{ github.event.inputs.auto_fix_tests || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance analysis**: ${{ github.event.inputs.run_performance_analysis || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.auto_fix_tests }}" = "true" ]; then
            echo "ğŸ’¡ **Tip**: If changes were committed, remember to pull them to your local branch!" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ’¡ **Tip**: Enable auto-fix to automatically apply optimizations and commit them!" >> $GITHUB_STEP_SUMMARY
          fi
