name: 游닍 GenAI - Dependency Analysis
on:
  workflow_dispatch:
    inputs:
      check_outdated:
        description: 'Verificar dependencias desactualizadas'
        required: false
        default: 'true'
        type: boolean
      check_security:
        description: 'Verificar vulnerabilidades de seguridad'
        required: false
        default: 'true'
        type: boolean
  schedule:
    # Ejecutar cada lunes a las 6:00 AM UTC
    - cron: '0 6 * * 1'

permissions:
  contents: read
  issues: write

jobs:
  dependency-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Check outdated packages
        id: outdated
        continue-on-error: true
        run: |
          mkdir -p dependency_reports
          flutter pub outdated > dependency_reports/outdated.txt 2>&1 || true
          echo "::group::Outdated packages"
          cat dependency_reports/outdated.txt
          echo "::endgroup::"

      - name: Analyze dependencies
        run: |
          flutter pub deps > dependency_reports/deps.txt 2>&1 || true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r .genaiscript/requirements.txt

      - name: Generate dependency report with GenAI
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GENAI_MODEL: 'gemini-2.0-flash-lite'
        run: |
          python .genaiscript/scripts/dependency_analysis.py > dependency_reports/analysis.md 2>&1 || true

      - name: Create issue with findings
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let body = '## 游닍 An치lisis de Dependencias\n\n';
            
            // Outdated packages
            body += '### Paquetes Desactualizados\n';
            try {
              const outdated = fs.readFileSync('dependency_reports/outdated.txt', 'utf8');
              body += '```\n' + outdated.substring(0, 10000) + '\n```\n\n';
            } catch (e) {
              body += '_No se pudo obtener informaci칩n._\n\n';
            }
            
            // GenAI analysis
            body += '### An치lisis Inteligente\n';
            try {
              const analysis = fs.readFileSync('dependency_reports/analysis.md', 'utf8');
              body += analysis.substring(0, 30000) + '\n\n';
            } catch (e) {
              body += '_No disponible._\n\n';
            }
            
            body += '---\n_Generado autom치ticamente_';
            
            // Check for existing open issues with same title
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,automated'
            });
            
            const today = new Date().toISOString().split('T')[0];
            const title = `游닍 Reporte de Dependencias - ${today}`;
            
            // Only create if no recent issue exists
            const recentIssue = existingIssues.data.find(i => 
              i.title.includes('Reporte de Dependencias') && 
              new Date(i.created_at) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            );
            
            if (!recentIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies', 'automated', 'genai']
              });
              console.log('Issue created successfully');
            } else {
              console.log('Recent issue already exists, skipping creation');
            }

      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports-${{ github.run_id }}
          path: dependency_reports/
          retention-days: 30
