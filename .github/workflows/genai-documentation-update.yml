name:  GenAI - Documentation Automation
on:
  workflow_dispatch:
    inputs:
      scope:
        description: 'Alcance de documentaci贸n: readme, api, architecture, all'
        required: false
        default: 'readme'
        type: choice
        options:
          - readme
          - api
          - architecture
          - all
      target_path:
        description: 'Ruta espec铆fica a documentar (opcional)'
        required: false
        default: ''
        type: string
  schedule:
    # Ejecutar el primer d铆a de cada mes para mantener docs actualizadas
    - cron: '0 4 1 * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r .genaiscript/requirements.txt

      - name: Run GenAI Documentation Generator
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GENAI_MODEL: 'gemini-2.0-flash-lite'
          DOC_SCOPE: ${{ github.event.inputs.scope || 'readme' }}
          DOC_TARGET_PATH: ${{ github.event.inputs.target_path || '' }}
        run: |
          echo ">>> Alcance de documentaci贸n: $DOC_SCOPE"
          python .genaiscript/scripts/generate_documentation.py || true

      - name: Commit documentation updates and create PR
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: update documentation generated by GenAI"
          branch: genai/docs-update-${{ github.run_id }}
          title: "[genai]  Documentation Update"
          body: |
            ##  Actualizaci贸n de Documentaci贸n por GenAI
            
            **Alcance:** ${{ github.event.inputs.scope || 'readme' }}
            **Ruta objetivo:** ${{ github.event.inputs.target_path || 'N/A' }}
            
            ### Cambios realizados
            - Actualizaci贸n autom谩tica de documentaci贸n
            - Sincronizaci贸n con cambios recientes en el c贸digo
            
            ### Acciones requeridas
            - [ ] Revisar los cambios en la documentaci贸n
            - [ ] Verificar precisi贸n t茅cnica
            - [ ] Aprobar y mergear si todo est谩 correcto
            
            ---
            _Documentaci贸n generada autom谩ticamente por GenAI._
          labels: automated,genai,documentation
          delete-branch: false

      - name: Comment PR with summary
        if: steps.create_pr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.create_pr.outputs.pull-request-number }}', 10);
            const body = `###  Resumen de Documentaci贸n Generada
            
            Se ha actualizado la documentaci贸n del repositorio.
            
            **Archivos modificados:** Revisar la pesta帽a "Files changed"
            
            Por favor, revisa los cambios para asegurar que la documentaci贸n sea precisa.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
