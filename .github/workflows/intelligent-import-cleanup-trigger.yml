name: Limpieza inteligente de imports y CI

on:
  workflow_dispatch: # Ejecuta manualmente desde Actions

jobs:
  analyze_and_cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üöÄ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: üì¶ Install dependencies
        run: flutter pub get

      # 1. An√°lisis inicial
      - name: üîç Analyze code (primer intento)
        id: analyze
        continue-on-error: true
        run: |
          echo "‚ñ∂Ô∏è Ejecutando an√°lisis de c√≥digo inicial..."
          flutter analyze > analyze.log || true
          cat analyze.log

      # 2. ¬øHubo error de importaci√≥n?
      - name: üìã Check for import errors
        id: imports
        run: |
          echo "‚ñ∂Ô∏è Buscando errores de importaci√≥n en el an√°lisis..."
          if grep -i "error" analyze.log | grep -i "import"; then
            echo "IMPORT_ERRORS=true" >> $GITHUB_ENV
            echo "‚ùó Se detectaron errores de importaci√≥n."
          else
            echo "IMPORT_ERRORS=false" >> $GITHUB_ENV
            echo "‚úÖ No se detectaron errores de importaci√≥n."
          fi

      # 3. Limpieza autom√°tica si hay errores de importaci√≥n
      - name: üßπ Cleanup imports if needed
        if: env.IMPORT_ERRORS == 'true'
        run: |
          echo "üßπ Ejecutando limpieza autom√°tica de imports y formato..."
          dart fix --apply
          dart format .
          echo "üîÑ Mostrando cambios realizados:"
          git diff --stat || echo "No hubo cambios."

      # 4. Re-an√°lisis
      - name: üîç Re-analyze after cleanup
        if: env.IMPORT_ERRORS == 'true'
        continue-on-error: true
        run: |
          echo "‚ñ∂Ô∏è Re-analizando c√≥digo tras la limpieza..."
          flutter analyze > reanalyze.log || true
          cat reanalyze.log

      # 5. ¬øYa se resolvieron los errores?
      - name: üìã Check if import errors are fixed
        if: env.IMPORT_ERRORS == 'true'
        run: |
          echo "‚ñ∂Ô∏è Comprobando si se resolvieron los errores de importaci√≥n..."
          if grep -i "error" reanalyze.log | grep -i "import"; then
            echo "ERRORS_REMAIN=true" >> $GITHUB_ENV
            echo "‚ùå Los errores de importaci√≥n persisten tras la limpieza."
          else
            echo "ERRORS_REMAIN=false" >> $GITHUB_ENV
            echo "‚úÖ Los errores de importaci√≥n fueron resueltos."
          fi

      # 6. Commit y PR solo si hubo limpieza exitosa y cambios
      - name: üìù Commit & Push cleanup changes
        if: env.IMPORT_ERRORS == 'true' && env.ERRORS_REMAIN == 'false'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Limpieza autom√°tica de imports no usados (detectado y corregido por CI)"
          branch: auto/import-cleanup
          push_options: --force

      - name: üîó Create Pull Request
        if: env.IMPORT_ERRORS == 'true' && env.ERRORS_REMAIN == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          branch: auto/import-cleanup
          title: "Limpieza autom√°tica de imports no usados"
          body: |
            Este PR elimina imports no usados tras detectar errores de importaci√≥n en el an√°lisis autom√°tico de CI.
            - An√°lisis inicial detect√≥ errores de importaci√≥n.
            - Limpieza autom√°tica aplicada con `dart fix --apply`.
            - Se verific√≥ que los errores fueron resueltos.
            - Revisa el diff para confirmar los cambios.
          labels: limpieza, autom√°tico, imports

      - name: üü¢ Normal CI: Analyze & Test
        if: env.IMPORT_ERRORS == 'false' || env.ERRORS_REMAIN == 'false'
        run: |
          echo "‚ñ∂Ô∏è Ejecutando an√°lisis final y pruebas unitarias..."
          flutter analyze --fatal-infos
          flutter test
