name: 游댌 GenAI - Code Quality Analysis
on:
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Tipo de an치lisis: lint, complexity, duplicates, all'
        required: false
        default: 'all'
        type: choice
        options:
          - lint
          - complexity
          - duplicates
          - all
      auto_fix:
        description: 'Aplicar correcciones autom치ticas'
        required: false
        default: 'false'
        type: boolean
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'lib/**/*.dart'

permissions:
  contents: write
  pull-requests: write

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run Dart Analyzer
        id: analyze
        continue-on-error: true
        run: |
          mkdir -p quality_reports
          dart analyze lib/ > quality_reports/analyzer_output.txt 2>&1 || true
          echo "analyze_exit=$?" >> $GITHUB_OUTPUT

      - name: Run dart format check
        id: format
        continue-on-error: true
        run: |
          dart format --set-exit-if-changed lib/ > quality_reports/format_output.txt 2>&1 || true
          echo "format_exit=$?" >> $GITHUB_OUTPUT

      - name: Apply auto-fixes (if enabled)
        if: github.event.inputs.auto_fix == 'true'
        run: |
          dart fix --apply lib/ || true
          dart format lib/ || true

      - name: Set up Python for GenAI analysis
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r .genaiscript/requirements.txt

      - name: Run GenAI Code Quality Analysis
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GENAI_MODEL: 'gemini-2.0-flash-lite'
          ANALYSIS_TYPE: ${{ github.event.inputs.analysis_type || 'all' }}
        run: |
          python .genaiscript/scripts/code_quality_analysis.py > quality_reports/genai_analysis.md 2>&1 || true

      - name: Generate combined report
        run: |
          echo "# 游댌 Reporte de Calidad de C칩digo" > quality_reports/combined_report.md
          echo "" >> quality_reports/combined_report.md
          echo "**Fecha:** $(date -u)" >> quality_reports/combined_report.md
          echo "" >> quality_reports/combined_report.md
          echo "## Dart Analyzer" >> quality_reports/combined_report.md
          echo '```' >> quality_reports/combined_report.md
          head -100 quality_reports/analyzer_output.txt >> quality_reports/combined_report.md || echo "Sin errores" >> quality_reports/combined_report.md
          echo '```' >> quality_reports/combined_report.md
          echo "" >> quality_reports/combined_report.md
          echo "## Formato de C칩digo" >> quality_reports/combined_report.md
          echo '```' >> quality_reports/combined_report.md
          head -50 quality_reports/format_output.txt >> quality_reports/combined_report.md || echo "Formato correcto" >> quality_reports/combined_report.md
          echo '```' >> quality_reports/combined_report.md
          echo "" >> quality_reports/combined_report.md
          echo "## An치lisis GenAI" >> quality_reports/combined_report.md
          cat quality_reports/genai_analysis.md >> quality_reports/combined_report.md || echo "No disponible" >> quality_reports/combined_report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let body = '';
            try {
              body = fs.readFileSync('quality_reports/combined_report.md', 'utf8');
            } catch (e) {
              body = '### 游댌 An치lisis de Calidad\n\nNo se pudo generar el reporte.';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body.substring(0, 65000)
            });

      - name: Create PR with fixes (if auto-fix enabled and changes exist)
        if: github.event.inputs.auto_fix == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "style: apply automated code quality fixes"
          branch: genai/code-quality-fixes-${{ github.run_id }}
          title: "[genai] 游댢 Code Quality Fixes"
          body: |
            ## 游댢 Correcciones Autom치ticas de Calidad
            
            Se han aplicado correcciones autom치ticas de:
            - `dart fix --apply`
            - `dart format`
            
            ### Acciones requeridas
            - [ ] Revisar los cambios
            - [ ] Verificar que los cambios son correctos
            - [ ] Aprobar y mergear
          labels: automated,genai,code-quality
          delete-branch: false

      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports-${{ github.run_id }}
          path: quality_reports/
          retention-days: 30
