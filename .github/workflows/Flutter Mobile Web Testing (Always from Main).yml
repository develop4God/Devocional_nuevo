name: Flutter Dev Validation (Web + Mobile Preview)
on:
  workflow_dispatch:
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/package_config.json
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Configure Flutter (disable analytics)
        run: flutter config --no-analytics
      - name: Show versions
        run: |
          flutter --version
          dart --version
      - name: Install dependencies
        run: flutter pub get
      - name: Analyze code (continue on warnings)
        run: flutter analyze
        continue-on-error: true
      - name: Run unit tests
        run: flutter test
        continue-on-error: true
      - name: Smart Web Build for Mobile Testing
        run: |
          # Array de opciones de build en orden de probabilidad de Ã©xito
          build_options=(
            "flutter build web --release --base-href ./ --no-tree-shake-icons"
            "flutter build web --release --base-href /${{ github.event.repository.name }}/ --no-tree-shake-icons --dart-define=FLUTTER_WEB_USE_SKIA=false"
            "flutter build web --release --base-href /${{ github.event.repository.name }}/ --no-tree-shake-icons --dart2js-optimization O4"
            "flutter build web --release --base-href /${{ github.event.repository.name }}/ --no-tree-shake-icons --no-web-resources-cdn"
            "flutter build web --release --base-href /${{ github.event.repository.name }}/ --no-tree-shake-icons"
            "flutter build web --release --no-tree-shake-icons"
            "flutter build web --debug --base-href /${{ github.event.repository.name }}/ --no-tree-shake-icons"
          )
          
          # Nombres descriptivos para cada opciÃ³n
          build_names=(
            "Base href ./ (GitHub Pages optimized)"
            "SKIA disabled for mobile compatibility"
            "Dart2js O4 optimization"
            "No web resources CDN"
            "Standard release with base href"
            "Basic release without base href"
            "Debug mode fallback"
          )
          
          success=false
          
          for i in "${!build_options[@]}"; do
            echo "ğŸ”„ Intentando opciÃ³n $((i+1)): ${build_names[$i]}"
            echo "ğŸ“‹ Comando: ${build_options[$i]}"
            
            # Limpiar build anterior si existe
            rm -rf build/web 2>/dev/null || true
            
            # Intentar el build
            if ${build_options[$i]}; then
              echo "âœ… Â¡Ã‰XITO! OpciÃ³n $((i+1)) funcionÃ³: ${build_names[$i]}"
              
              # Si es la opciÃ³n bÃ¡sica sin base href, agregarlo manualmente
              if [[ $i -eq 5 ]]; then
                echo "ğŸ”§ Agregando base href manualmente..."
                sed -i 's/<base href="\/">/<base href="\/${{ github.event.repository.name }}\/">/' build/web/index.html
              fi
              
              # Verificar que se generaron los archivos crÃ­ticos
              if [[ -f "build/web/index.html" ]]; then
                echo "âœ… index.html generado correctamente"
                
                # Verificar si existe main.dart.js o flutter.js
                if [[ -f "build/web/main.dart.js" || -f "build/web/flutter.js" ]]; then
                  echo "âœ… Archivos JavaScript verificados"
                  echo "ğŸ“ Contenido generado:"
                  ls -la build/web/ | head -10
                  success=true
                  break
                else
                  echo "âš ï¸  JavaScript files not found, checking for other patterns..."
                  find build/web -name "*.js" | head -5
                  if [[ $(find build/web -name "*.js" | wc -l) -gt 0 ]]; then
                    echo "âœ… Found JavaScript files, continuing..."
                    success=true
                    break
                  fi
                fi
              else
                echo "âŒ Build exitoso pero falta index.html"
              fi
            else
              echo "âŒ FallÃ³ opciÃ³n $((i+1)): ${build_names[$i]}"
              echo "â­ï¸  Probando siguiente opciÃ³n..."
              echo ""
            fi
          done
          
          if [[ "$success" != "true" ]]; then
            echo "ğŸ’¥ ERROR: Todas las opciones de build fallaron"
            echo "ğŸ“‹ Opciones probadas:"
            for j in "${!build_names[@]}"; do
              echo "  $((j+1)). ${build_names[$j]}"
            done
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ =================================="
          echo "âœ… BUILD EXITOSO CON: ${build_names[$i]}"
          echo "ğŸ‰ =================================="
          echo "ğŸ“‹ Comando ganador: ${build_options[$i]}"
      - name: Deploy to GitHub Pages for mobile testing
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
          force_orphan: true
      
      - name: Wait for GitHub Pages deployment
        run: |
          echo "â³ Esperando que GitHub Pages procese el deployment..."
          sleep 60
      
      - name: ğŸ” VALIDATE APP ACTUALLY WORKS
        run: |
          APP_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ” Validando que la app realmente funcione en: $APP_URL"
          
          # FunciÃ³n para verificar la app
          check_app() {
            local attempt=$1
            echo "ğŸŒ Intento $attempt: Verificando $APP_URL"
            
            # Descargar la pÃ¡gina
            response=$(curl -s -L -w "%{http_code}" "$APP_URL" -o page_content.html)
            http_code="${response: -3}"
            
            echo "ğŸ“Š HTTP Status: $http_code"
            
            if [[ "$http_code" -eq 200 ]]; then
              echo "âœ… PÃ¡gina accesible (HTTP 200)"
              
              # Verificar contenido crÃ­tico
              echo "ğŸ” Verificando contenido de la pÃ¡gina..."
              
              # Check 1: Tiene HTML vÃ¡lido
              if grep -q "<html" page_content.html; then
                echo "âœ… HTML structure found"
              else
                echo "âŒ No HTML structure found"
                return 1
              fi
              
              # Check 2: Tiene Flutter bootstrap o main.dart.js
              if grep -q "flutter_bootstrap.js\|main.dart.js\|flutter.js" page_content.html; then
                echo "âœ… Flutter JavaScript files referenced"
              else
                echo "âŒ No Flutter JavaScript references found"
                echo "ğŸ“„ Page content preview:"
                head -20 page_content.html
                return 1
              fi
              
              # Check 3: Tiene base href correcto
              if grep -q 'base href.*/' page_content.html; then
                echo "âœ… Base href configured"
                grep 'base href' page_content.html
              else
                echo "âš ï¸  No base href found (might be ok)"
              fi
              
              # Check 4: No es pÃ¡gina de error
              if grep -qi "404\|not found\|error" page_content.html; then
                echo "âŒ Error page detected"
                return 1
              fi
              
              echo "âœ… PÃ¡gina parece vÃ¡lida"
              return 0
            else
              echo "âŒ HTTP $http_code - PÃ¡gina no accesible"
              return 1
            fi
          }
          
          # Intentar validar 3 veces con esperas
          success=false
          for attempt in {1..3}; do
            if check_app $attempt; then
              success=true
              break
            else
              if [[ $attempt -lt 3 ]]; then
                echo "â³ Esperando 30 segundos antes del siguiente intento..."
                sleep 30
              fi
            fi
          done
          
          if [[ "$success" != "true" ]]; then
            echo ""
            echo "ğŸ’¥ =================================="
            echo "âŒ VALIDACIÃ“N FALLÃ“"
            echo "ğŸ’¥ =================================="
            echo "ğŸš¨ La app NO estÃ¡ funcionando correctamente"
            echo "ğŸŒ URL: $APP_URL"
            echo "ğŸ“‹ La pÃ¡gina estÃ¡ accesible pero el contenido no es vÃ¡lido"
            echo "ğŸ”§ Posibles causas:"
            echo "   â€¢ Base href incorrecto"
            echo "   â€¢ Archivos JavaScript no se cargan"
            echo "   â€¢ Flutter no se inicializa"
            echo "   â€¢ PÃ¡gina completamente en blanco"
            echo ""
            echo "ğŸ“„ Contenido actual de la pÃ¡gina:"
            cat page_content.html
            echo ""
            echo "ğŸ’¡ RecomendaciÃ³n: Revisar la configuraciÃ³n del build"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ =================================="
          echo "âœ… VALIDACIÃ“N EXITOSA"
          echo "ğŸ‰ =================================="
          echo "âœ… La app estÃ¡ funcionando correctamente"
          echo "ğŸŒ URL: $APP_URL"
      - name: ğŸ“± MOBILE TESTING READY
        run: |
          echo "ğŸ‰ =================================="
          echo "ğŸ“± TU APP ESTÃ LISTA PARA TESTING!"
          echo "ğŸ‰ =================================="
          echo ""
          echo "ğŸŒ URL DIRECTA (copia y pega en tu celular):"
          echo "ğŸ‘‰ https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "â±ï¸  TIEMPO DE ESPERA: 2-3 minutos mÃ¡ximo"
          echo ""
          echo "ğŸ“± PASOS EN TU CELULAR:"
          echo "   1ï¸âƒ£ Copia la URL de arriba"
          echo "   2ï¸âƒ£ PÃ©gala en Chrome/Safari mÃ³vil"
          echo "   3ï¸âƒ£ Si no carga, espera 1 min mÃ¡s y refresh"
          echo ""
          echo "ğŸ” TESTING DE OVERFLOW:"
          echo "   âœ… Rota pantalla (portrait/landscape)"
          echo "   âœ… Scroll vertical y horizontal"
          echo "   âœ… Prueba todos los botones y forms"
          echo "   âœ… Navega entre pantallas"
          echo ""
          echo "ğŸ‰ =================================="
      - name: Validation completed
        run: echo "âœ… ValidaciÃ³n completada. Proyecto listo para desarrollo web y mÃ³vil."
