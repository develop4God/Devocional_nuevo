name: Flutter Mobile Web Testing (Always from Main)

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to test (leave empty for current)'
        required: false
        default: ''
  push:
    branches: [ main, develop, feature/**, fix/** ]
  pull_request:
    branches: [ main ]

jobs:
  mobile-web-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch || github.ref }}

      - name: Show branch info
        run: |
          echo "ğŸŒ¿ TESTING BRANCH: ${{ github.event.inputs.target_branch || github.ref_name }}"
          echo "âš™ï¸  WORKFLOW FROM: main (always)"

      - name: Cache Flutter dependencies (optimized)
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-flutter-all-${{ hashFiles('**/pubspec.yaml', '**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-flutter-all-
            ${{ runner.os }}-flutter-

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Configure Flutter
        run: flutter config --no-analytics

      - name: Install dependencies (fast)
        run: flutter pub get --no-precompile

      - name: Build web for mobile (optimized)
        run: flutter build web --debug --dart2js-optimization O1

      - name: Deploy to GitHub Pages for mobile testing
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
          publish_branch: gh-pages-mobile
          force_orphan: true

      - name: ğŸ“± MOBILE TESTING - URL READY!
        run: |
          echo "ğŸ‰ =================================="
          echo "ğŸ“± TU APP ESTÃ LISTA PARA TESTING!"
          echo "ğŸ‰ =================================="
          echo ""
          echo "ğŸŒ URL DIRECTA (copia y pega en tu celular):"
          echo "ğŸ‘‰ https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "â±ï¸  TIEMPO DE ESPERA: 2-3 minutos mÃ¡ximo"
          echo ""
          echo "ğŸ“± PASOS EN TU CELULAR:"
          echo "   1ï¸âƒ£ Copia la URL de arriba"
          echo "   2ï¸âƒ£ PÃ©gala en Chrome/Safari mÃ³vil"
          echo "   3ï¸âƒ£ Si no carga, espera 1 min mÃ¡s y refresh"
          echo ""
          echo "ğŸ” TESTING DE OVERFLOW:"
          echo "   âœ… Rota pantalla (portrait/landscape)"
          echo "   âœ… Scroll vertical y horizontal"
          echo "   âœ… Prueba todos los botones y forms"
          echo "   âœ… Navega entre pantallas"
          echo ""
          echo "ğŸ”„ PARA NUEVOS CAMBIOS:"
          echo "   â€¢ Edita cÃ³digo â†’ Run workflow â†’ Refresh URL"
          echo ""
          echo "ğŸš€ BRANCH TESTEADO: ${{ github.event.inputs.target_branch || github.ref_name }}"
          echo "ğŸ‰ =================================="
