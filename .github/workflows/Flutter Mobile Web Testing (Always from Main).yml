name: Flutter Mobile Web Testing (Always from Main)

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to test (leave empty for current)'
        required: false
        default: ''

jobs:
  mobile-web-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch || github.ref }}

      - name: Show branch info
        run: |
          echo "ğŸŒ¿ TESTING BRANCH: ${{ github.event.inputs.target_branch || github.ref_name }}"
          echo "âš™ï¸  WORKFLOW FROM: main (always)"

      - name: Cache Flutter dependencies (optimized)
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-flutter-all-${{ hashFiles('**/pubspec.yaml', '**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-flutter-all-
            ${{ runner.os }}-flutter-

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Configure Flutter
        run: flutter config --no-analytics

      - name: Install dependencies (fast)
        run: flutter pub get --no-precompile

      - name: Build web for mobile (optimized)
        run: flutter build web --debug --dart2js-optimization O1

      - name: Upload web build for download
        uses: actions/upload-artifact@v4
        with:
          name: flutter-web-app
          path: build/web/

      - name: ğŸ“± DOWNLOAD AND TEST LOCALLY
        run: |
          echo "ğŸ‰ =================================="
          echo "ğŸ“± WEB BUILD READY FOR DOWNLOAD!"
          echo "ğŸ‰ =================================="
          echo ""
          echo "ğŸ“¥ PASOS PARA TESTING:"
          echo "   1ï¸âƒ£ Ve a 'Actions' â†’ este workflow â†’ 'Artifacts'"
          echo "   2ï¸âƒ£ Descarga 'flutter-web-app.zip'"
          echo "   3ï¸âƒ£ Descomprime el ZIP"
          echo "   4ï¸âƒ£ Abre 'index.html' en Chrome mÃ³vil"
          echo ""
          echo "ğŸ” TESTING DE OVERFLOW:"
          echo "   âœ… Rota pantalla (portrait/landscape)"
          echo "   âœ… Scroll vertical y horizontal"
          echo "   âœ… Prueba todos los botones y forms"
          echo "   âœ… Navega entre pantallas"
          echo ""
          echo "ğŸš€ BRANCH TESTEADO: ${{ github.event.inputs.target_branch || github.ref_name }}"
          echo "ğŸ‰ =================================="
