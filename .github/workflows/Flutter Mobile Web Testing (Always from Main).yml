name: Flutter Mobile Web Testing (Always from Main)

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to test (leave empty for current)'
        required: false
        default: ''

jobs:
  mobile-web-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch || github.ref }}

      - name: Show branch info
        run: |
          echo "🌿 TESTING BRANCH: ${{ github.event.inputs.target_branch || github.ref_name }}"
          echo "⚙️  WORKFLOW FROM: main (always)"

      - name: Cache Flutter dependencies (optimized)
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-flutter-all-${{ hashFiles('**/pubspec.yaml', '**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-flutter-all-
            ${{ runner.os }}-flutter-

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Configure Flutter
        run: flutter config --no-analytics

      - name: Install dependencies (fast)
        run: flutter pub get --no-precompile

      - name: Build web for mobile (optimized)
        run: flutter build web --debug --dart2js-optimization O1

      - name: Upload web build for download
        uses: actions/upload-artifact@v4
        with:
          name: flutter-web-app
          path: build/web/

      - name: 📱 DOWNLOAD AND TEST LOCALLY
        run: |
          echo "🎉 =================================="
          echo "📱 WEB BUILD READY FOR DOWNLOAD!"
          echo "🎉 =================================="
          echo ""
          echo "📥 PASOS PARA TESTING:"
          echo "   1️⃣ Ve a 'Actions' → este workflow → 'Artifacts'"
          echo "   2️⃣ Descarga 'flutter-web-app.zip'"
          echo "   3️⃣ Descomprime el ZIP"
          echo "   4️⃣ Abre 'index.html' en Chrome móvil"
          echo ""
          echo "🔍 TESTING DE OVERFLOW:"
          echo "   ✅ Rota pantalla (portrait/landscape)"
          echo "   ✅ Scroll vertical y horizontal"
          echo "   ✅ Prueba todos los botones y forms"
          echo "   ✅ Navega entre pantallas"
          echo ""
          echo "🚀 BRANCH TESTEADO: ${{ github.event.inputs.target_branch || github.ref_name }}"
          echo "🎉 =================================="
