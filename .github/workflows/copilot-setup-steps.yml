name: "Flutter Environment for GitHub Copilot"

on:
  workflow_dispatch:
    inputs:
      flutter_version:
        description: 'Flutter version to use'
        required: false
        default: '3.32.8'
        type: string
      run_tests:
        description: 'Run tests (non-blocking)'
        required: false
        default: true
        type: boolean
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
      - pubspec.yaml
      - pubspec.lock
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml
      - pubspec.yaml
      - pubspec.lock

jobs:
  flutter-environment-setup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    
    # Set environment variables that Copilot can reference
    env:
      FLUTTER_VERSION: ${{ github.event.inputs.flutter_version || '3.32.8' }}
      COPILOT_ENV: 'flutter-ready'
    
    steps:
      - name: 📂 Checkout Repository
        uses: actions/checkout@v4
        with:
          # Fetch more history for better context
          fetch-depth: 2

      - name: 🔍 Validate pubspec.yaml exists
        run: |
          if [ ! -f "pubspec.yaml" ]; then
            echo "❌ pubspec.yaml not found. This doesn't appear to be a Flutter project."
            exit 1
          fi
          echo "✅ Flutter project detected"

      - name: 🐦 Setup Flutter Environment
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          cache-key: 'flutter-${{ env.FLUTTER_VERSION }}-${{ runner.os }}'
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:'
          architecture: x64

      - name: 📦 Get Flutter Dependencies
        run: |
          echo "Installing Flutter dependencies..."
          flutter pub get
          
          # Verify dependencies were installed
          if [ -d ".dart_tool" ]; then
            echo "✅ Dependencies installed successfully"
          else
            echo "❌ Failed to install dependencies"
            exit 1
          fi

      - name: 🤖 Accept Android SDK Licenses
        run: |
          echo "Accepting Android SDK licenses..."
          yes | flutter doctor --android-licenses 2>/dev/null || true
          echo "✅ Android licenses accepted"

      - name: 🩺 Flutter Doctor Diagnosis
        run: |
          echo "Running Flutter doctor..."
          flutter doctor -v
          
          # Check if Flutter is properly configured
          if flutter doctor | grep -q "No issues found!"; then
            echo "✅ Flutter environment is fully configured"
          else
            echo "⚠️ Flutter has some issues, but continuing..."
          fi

      - name: 🎨 Format Dart Code
        run: |
          echo "Formatting Dart code..."
          dart format --set-exit-if-changed . || echo "⚠️ Code formatting issues found (non-blocking)"

      - name: 🔍 Analyze Flutter Code
        run: |
          echo "Analyzing Flutter/Dart code..."
          flutter analyze --no-fatal-infos || echo "⚠️ Analysis issues found (non-blocking)"

      - name: 🧪 Run Flutter Tests (Non-blocking)
        if: ${{ github.event.inputs.run_tests == 'true' || github.event.inputs.run_tests == null }}
        run: |
          echo "Running Flutter tests (non-blocking)..."
          if [ -d "test" ]; then
            flutter test --reporter=expanded --coverage || echo "⚠️ Tests failed or incomplete (non-blocking)"
            
            # Generate test report if tests exist
            if [ -f "coverage/lcov.info" ]; then
              echo "📊 Test coverage generated"
            fi
          else
            echo "📝 No test directory found - skipping tests"
          fi

      - name: 📋 Environment Summary
        run: |
          echo "🎉 Flutter Environment Setup Complete!"
          echo "=================================="
          echo "Flutter Version: $(flutter --version | head -1)"
          echo "Dart Version: $(dart --version)"
          echo "Environment: ${{ env.COPILOT_ENV }}"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "=================================="
          
          # Create environment file for Copilot reference
          cat > copilot-env-info.txt << EOF
          FLUTTER_READY=true
          FLUTTER_VERSION=${{ env.FLUTTER_VERSION }}
          DART_VERSION=$(dart --version 2>&1 | cut -d' ' -f4)
          SETUP_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          PROJECT_TYPE=Flutter
          DEPENDENCIES_INSTALLED=true
          TESTS_AVAILABLE=$([ -d "test" ] && echo "true" || echo "false")
          EOF
          
          echo "📄 Environment info saved to copilot-env-info.txt"

      - name: 🔧 Cache Flutter Build Files
        uses: actions/cache@v4
        with:
          path: |
            build
            .dart_tool
          key: ${{ runner.os }}-flutter-build-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-build-

      # Optional: Create a simple test build to ensure everything works
      - name: 🏗️ Test Build (Android APK)
        run: |
          echo "Testing Android build capability..."
          flutter build apk --debug --no-shrink || echo "⚠️ Build test failed (non-blocking)"

  # Job to notify about environment status
  notify-copilot:
    needs: flutter-environment-setup
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: 📢 Environment Status
        run: |
          if [ "${{ needs.flutter-environment-setup.result }}" == "success" ]; then
            echo "✅ Flutter environment is ready for GitHub Copilot!"
            echo "🤖 You can now ask Copilot to:"
            echo "   - Analyze Flutter/Dart code"
            echo "   - Run flutter commands"
            echo "   - Execute tests"
            echo "   - Build the project"
          else
            echo "❌ Flutter environment setup failed"
            echo "🔧 Check the logs above for issues"
          fi
