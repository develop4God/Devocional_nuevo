name: Update README Statistics

on:
  push:
    branches: [main, develop]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'i18n/**'
      - 'pubspec.yaml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'i18n/**'
      - 'pubspec.yaml'
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Update README statistics
        run: dart scripts/update_readme_stats.dart
        continue-on-error: false
      
      - name: Check for changes
        id: verify
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to README.md"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "README.md has been updated"
            # save the diff for later PR comment
            echo "diff<<EOF" >> $GITHUB_OUTPUT
            git --no-pager diff README.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: Show README changes
        if: steps.verify.outputs.changed == 'true'
        run: |
          echo "ðŸ“Š README.md changes:"
          git --no-pager diff README.md
      
      - name: Commit and push changes
        if: steps.verify.outputs.changed == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "docs: Auto-update README statistics [skip ci]"
          # Push using HEAD so it works from detached head
          git push origin HEAD:${GITHUB_REF#refs/heads/}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on PR
        if: steps.verify.outputs.changed == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### ðŸ“Š README Statistics Update

            The README.md statistics have been automatically updated based on the current codebase.

            **What changed:**
            - File counts updated from actual codebase
            - Language support updated from i18n directory

            **To apply these changes:**
            Run \`dart scripts/update_readme_stats.dart\` locally and commit the changes.

            <details>
            <summary>View changes</summary>

            \`\`\`diff
            ${process.env.DIFF_OUTPUT}
            \`\`\`
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
        env:
          DIFF_OUTPUT: ${{ steps.verify.outputs.diff }}
      
      - name: Summary
        if: steps.verify.outputs.changed == 'true'
        run: |
          echo "âœ… README.md statistics updated successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes made:" >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          git --no-pager diff HEAD~1 README.md | head -50 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: No changes needed
        if: steps.verify.outputs.changed == 'false'
        run: |
          echo "âœ… README.md is already up to date" >> $GITHUB_STEP_SUMMARY
