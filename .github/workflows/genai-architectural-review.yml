name: üèóÔ∏è GenAI - Architectural Review
on:
  workflow_dispatch:
    inputs:
      review_type:
        description: 'Tipo de revisi√≥n: full, security, performance, patterns'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - security
          - performance
          - patterns
      create_issues:
        description: 'Crear issues para hallazgos'
        required: false
        default: 'false'
        type: boolean
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'lib/**/*.dart'
      - 'pubspec.yaml'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  architectural-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r .genaiscript/requirements.txt

      - name: Run Architectural Review
        id: review
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GENAI_MODEL: 'gemini-2.0-flash-lite'
          REVIEW_TYPE: ${{ github.event.inputs.review_type || 'full' }}
          CREATE_ISSUES: ${{ github.event.inputs.create_issues || 'false' }}
        run: |
          echo ">>> Tipo de revisi√≥n: $REVIEW_TYPE"
          python .genaiscript/scripts/architectural_review.py > review_output.md 2>&1 || true
          echo "review_completed=true" >> $GITHUB_OUTPUT

      - name: Comment on PR with review results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let reviewContent = '### üèóÔ∏è Revisi√≥n Arquitect√≥nica Autom√°tica\n\n';
            try {
              reviewContent += fs.readFileSync('review_output.md', 'utf8');
            } catch (e) {
              reviewContent += '_No se pudo generar la revisi√≥n._\n';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewContent
            });

      - name: Create summary issue (manual trigger only)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_issues == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let reviewContent = '';
            try {
              reviewContent = fs.readFileSync('review_output.md', 'utf8');
            } catch (e) {
              reviewContent = 'No se pudo generar la revisi√≥n.';
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üèóÔ∏è Revisi√≥n Arquitect√≥nica - ' + new Date().toISOString().split('T')[0],
              body: `## Revisi√≥n Arquitect√≥nica Autom√°tica\n\n${reviewContent}\n\n---\n_Generado autom√°ticamente por GenAI_`,
              labels: ['architectural-review', 'automated', 'genai']
            });

      - name: Upload review artifact
        uses: actions/upload-artifact@v4
        with:
          name: architectural-review-${{ github.run_id }}
          path: review_output.md
          retention-days: 30
