name: ðŸ¤– GenAI - Generate Flutter Behavioral Tests and Run
on:
  workflow_dispatch: {}
  push:
    branches:
      - 'genaiscripts/tests'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r .genaiscript/requirements.txt

      - name: Run GenAI test generator (Python)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GENAI_MODEL: 'gemini-2.0-flash-lite'
          GENAI_MAX_TOKENS: '4096'
          REQUIRE_HUMAN_REVIEW: 'true'
        run: |
          python .genaiscript/scripts/generate_tests_dart.py || true

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: stable
          cache: true

      - name: Show Flutter location and version
        run: |
          echo ">>> FLUTTER_HOME: $FLUTTER_HOME"
          which flutter || true
          flutter --version || true
          echo ">>> PATH:"
          echo $PATH

      - name: Install dependencies
        run: flutter pub get

      - name: Accept Android Licenses
        run: yes | flutter doctor --android-licenses

      - name: Run flutter doctor
        run: flutter doctor -v

      - name: Run behavioral tests (capture output)
        id: run_tests
        run: |
          mkdir -p test_output
          if [ -d "test/behavioral" ]; then
            echo "Running behavioral tests..."
            flutter test test/behavioral/ > test_output/behavioral_tests.txt 2>&1 || TEST_EXIT_CODE=$?
          else
            echo "No behavioral tests directory found." > test_output/behavioral_tests.txt
            TEST_EXIT_CODE=0
          fi
          echo "exit_code=${TEST_EXIT_CODE:-0}" >> $GITHUB_OUTPUT
          head -c 4000 test_output/behavioral_tests.txt > test_output/behavioral_summary.txt
          echo "::group::Behavioral tests output (full)"
          cat test_output/behavioral_tests.txt || true
          echo "::endgroup::"

      - name: Commit generated tests and create PR (if changes)
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(tests): add behavioral Flutter tests generated by GenAI"
          branch: genai/flutter-tests-${{ github.run_id }}
          title: "[genai] Add behavioral Flutter tests"
          body: |
            Behavioral tests generated by GenAI (Gemini) focused on real user scenarios.
            Please review the tests in test/behavioral/ before merging.

            ---
            Behavioral test run exit code: ${{ steps.run_tests.outputs.exit_code }}
          labels: automated,genai,tests
          delete-branch: false

      - name: Comment PR with test results
        if: steps.create_pr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = parseInt(process.env.PR_NUMBER || '${{ steps.create_pr.outputs.pull-request-number }}', 10);
            let body = '### Behavioral Test Execution Results\\n\\n';
            try {
              const txt = fs.readFileSync('test_output/behavioral_tests.txt', 'utf8');
              body += '```\n' + txt.substring(0, 64000) + '\n```\n';
            } catch (e) {
              body += '_No test output found._\\n';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
        env:
          PR_NUMBER: ${{ steps.create_pr.outputs.pull-request-number }}
