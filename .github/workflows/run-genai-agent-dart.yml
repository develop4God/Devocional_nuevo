name: ðŸ¤– GenAI - Generate BLoC Tests
on:
  workflow_dispatch:
  push:
    branches:
      - 'genaiscripts/tests'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate tests with Gemini
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GENAI_MODEL: 'gemini-2.0-flash'
        run: |
          python .genaiscript/scripts/generate_tests_dart_optimized.py

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: stable
          cache: true

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Generate mocks
        run: |
          flutter pub run build_runner build --delete-conflicting-outputs || echo "Mock generation warnings ignored"

      - name: Run behavioral tests
        id: run_tests
        continue-on-error: true
        run: |
          mkdir -p test_output
          if [ -d "test/behavioral" ]; then
            flutter test test/behavioral/ --reporter expanded > test_output/results.txt 2>&1 || TEST_EXIT=$?
            echo "exit_code=${TEST_EXIT:-0}" >> $GITHUB_OUTPUT
            head -c 5000 test_output/results.txt > test_output/summary.txt
          else
            echo "No tests generated" > test_output/results.txt
            echo "exit_code=0" >> $GITHUB_OUTPUT
          fi

      - name: Create PR with generated tests
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "test: add BLoC behavioral tests (GenAI)"
          branch: genai/bloc-tests-${{ github.run_id }}
          title: "ðŸ¤– [GenAI] BLoC Behavioral Tests"
          body: |
            ## Generated BLoC Tests
            
            Tests generated using optimized Gemini prompts (<1000 tokens).
            Focus: User flows, BLoC patterns, real scenarios.
            
            **Test Results:**
            - Exit code: ${{ steps.run_tests.outputs.exit_code }}
            - Location: `test/behavioral/`
            
            **Review Checklist:**
            - [ ] Tests compile without errors
            - [ ] Scenarios reflect real user behavior
            - [ ] Mocks are properly configured
            - [ ] Assertions are meaningful
            
            See comment below for detailed results.
          labels: automated,genai,tests,bloc
          delete-branch: true

      - name: Comment test results on PR
        if: steps.create_pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = '${{ steps.create_pr.outputs.pull-request-number }}';
            
            let body = '### Test Execution Results\n\n';
            body += '**Exit Code:** ${{ steps.run_tests.outputs.exit_code }}\n\n';
            
            try {
              const results = fs.readFileSync('test_output/results.txt', 'utf8');
              body += '```\n' + results.substring(0, 60000) + '\n```\n';
            } catch (e) {
              body += '_No test output available_\n';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber),
              body: body
            });
