name:  GenAI - Generate Flutter Behavioral Tests and Run
on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Modo de generaci贸n: modified, coverage, all'
        required: false
        default: 'coverage'
        type: choice
        options:
          - modified
          - coverage
          - all
      max_files:
        description: 'M谩ximo de archivos a procesar'
        required: false
        default: '10'
        type: string
      validate_syntax:
        description: 'Validar sintaxis de tests generados'
        required: false
        default: 'true'
        type: boolean
  schedule:
    # Ejecutar todos los domingos a las 3:00 AM UTC para aumentar cobertura
    - cron: '0 3 * * 0'
  push:
    branches:
      - 'genaiscripts/tests'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r .genaiscript/requirements.txt

      - name: Run GenAI test generator (Python)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GENAI_MODEL: 'gemini-2.0-flash-lite'
          GENAI_MODE: ${{ github.event.inputs.mode || 'coverage' }}
          GENAI_MAX_FILES: ${{ github.event.inputs.max_files || '10' }}
          GENAI_VALIDATE_SYNTAX: ${{ github.event.inputs.validate_syntax || 'true' }}
          REQUIRE_HUMAN_REVIEW: 'true'
        run: |
          echo ">>> Modo de generaci贸n: $GENAI_MODE"
          echo ">>> Max archivos: $GENAI_MAX_FILES"
          python .genaiscript/scripts/generate_tests_dart.py || true

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: stable
          cache: true

      - name: Show Flutter location and version
        run: |
          echo ">>> FLUTTER_HOME: $FLUTTER_HOME"
          which flutter || true
          flutter --version || true
          echo ">>> PATH:"
          echo $PATH

      - name: Install dependencies
        run: flutter pub get

      - name: Accept Android Licenses
        run: yes | flutter doctor --android-licenses

      - name: Run flutter doctor
        run: flutter doctor -v

      - name: Run behavioral tests (capture output)
        id: run_tests
        run: |
          mkdir -p test_output
          if [ -d "test/behavioral" ]; then
            echo "Running behavioral tests..."
            flutter test test/behavioral/ > test_output/behavioral_tests.txt 2>&1 || TEST_EXIT_CODE=$?
          else
            echo "No behavioral tests directory found." > test_output/behavioral_tests.txt
            TEST_EXIT_CODE=0
          fi
          echo "exit_code=${TEST_EXIT_CODE:-0}" >> $GITHUB_OUTPUT
          head -c 4000 test_output/behavioral_tests.txt > test_output/behavioral_summary.txt
          echo "::group::Behavioral tests output (full)"
          cat test_output/behavioral_tests.txt || true
          echo "::endgroup::"

      - name: Run full test suite with coverage
        id: full_tests
        continue-on-error: true
        run: |
          mkdir -p coverage
          flutter test --coverage > test_output/full_tests.txt 2>&1 || FULL_EXIT=$?
          echo "full_exit_code=${FULL_EXIT:-0}" >> $GITHUB_OUTPUT
          echo "::group::Full test suite output"
          cat test_output/full_tests.txt || true
          echo "::endgroup::"

      - name: Generate coverage report
        continue-on-error: true
        run: |
          if [ -f "coverage/lcov.info" ]; then
            echo "Coverage file found, generating summary..."
            # Calcular l铆neas cubiertas
            TOTAL_LINES=$(grep -c "^DA:" coverage/lcov.info || echo "0")
            COVERED_LINES=$(grep "^DA:" coverage/lcov.info | grep -v ",0$" | wc -l || echo "0")
            if [ "$TOTAL_LINES" -gt 0 ]; then
              COVERAGE_PCT=$(echo "scale=2; $COVERED_LINES * 100 / $TOTAL_LINES" | bc)
              echo "Coverage: $COVERAGE_PCT% ($COVERED_LINES/$TOTAL_LINES lines)"
              echo "coverage_pct=$COVERAGE_PCT" >> $GITHUB_OUTPUT
            fi
          else
            echo "No coverage file found"
          fi

      - name: Commit generated tests and create PR (if changes)
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(tests): add behavioral Flutter tests generated by GenAI"
          branch: genai/flutter-tests-${{ github.run_id }}
          title: "[genai] Add behavioral Flutter tests"
          body: |
            ##  Tests generados por GenAI (Gemini)
            
            **Modo de generaci贸n:** ${{ github.event.inputs.mode || 'coverage' }}
            **Archivos procesados:** hasta ${{ github.event.inputs.max_files || '10' }}
            
            ### Resultados de ejecuci贸n
            - Behavioral test run exit code: ${{ steps.run_tests.outputs.exit_code }}
            - Full test suite exit code: ${{ steps.full_tests.outputs.full_exit_code }}
            
            ### Acciones requeridas
            - [ ] Revisar los tests generados en `test/behavioral/`
            - [ ] Verificar que los tests son correctos y 煤tiles
            - [ ] Aprobar y mergear si todo est谩 bien
            
            ---
            _Tests centrados en comportamiento real de usuario._
          labels: automated,genai,tests
          delete-branch: false

      - name: Comment PR with test results
        if: steps.create_pr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = parseInt(process.env.PR_NUMBER || '${{ steps.create_pr.outputs.pull-request-number }}', 10);
            let body = '###  Resultado de ejecuci贸n de tests\n\n';
            
            // Behavioral tests
            body += '#### Tests de comportamiento\n';
            try {
              const txt = fs.readFileSync('test_output/behavioral_tests.txt', 'utf8');
              body += '```\n' + txt.substring(0, 30000) + '\n```\n';
            } catch (e) {
              body += '_No se encontr贸 salida de tests de comportamiento._\n';
            }
            
            // Full test suite
            body += '\n#### Suite completa de tests\n';
            try {
              const fullTxt = fs.readFileSync('test_output/full_tests.txt', 'utf8');
              body += '```\n' + fullTxt.substring(0, 30000) + '\n```\n';
            } catch (e) {
              body += '_No se encontr贸 salida de tests completos._\n';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
        env:
          PR_NUMBER: ${{ steps.create_pr.outputs.pull-request-number }}
